<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Защищенный просмотр PDF</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            height: 100vh;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px 16px;
            text-align: center;
            position: relative;
            z-index: 1000;
            border-bottom: 1px solid var(--tg-theme-hint-color, #999999);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .viewer-container {
            flex: 1;
            position: relative;
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
            flex-direction: column;
            gap: 12px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-top: 3px solid var(--tg-theme-button-color, #2481cc);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            color: var(--tg-theme-destructive-text-color, #e74c3c);
            text-align: center;
            padding: 20px;
            gap: 16px;
        }

        .error button {
            padding: 12px 24px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .tma-back-button {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 16px;
            color: var(--tg-theme-button-color, #2481cc);
            cursor: pointer;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Запрет выделения текста */
        .no-selection {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Адаптация для TMA */
        @media (max-width: 768px) {
            .header {
                padding: 10px 16px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                font-size: 13px;
            }
        }
    </style>
</head>
<body class="no-selection">
    <div class="container">
        <div class="header">
            <button class="tma-back-button" id="backButton">← Назад</button>
            <h1>Защищенный просмотр документа</h1>
            <p>Копирование и скачивание запрещено</p>
        </div>
        
        <div class="viewer-container">
            <div id="pdfContainer" class="loading">
                <div class="loading-spinner"></div>
                <div>Загрузка документа...</div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        let tg = null;
        
        // Проверяем, запущено ли в TMA
        function isTelegramWebApp() {
            return window.Telegram && window.Telegram.WebApp;
        }

        // Инициализация TMA
        function initTelegramWebApp() {
            if (isTelegramWebApp()) {
                tg = window.Telegram.WebApp;
                tg.expand(); // Раскрываем на весь экран
                tg.enableClosingConfirmation(); // Запрос подтверждения при закрытии
                
                // Настраиваем кнопку назад
                const backButton = document.getElementById('backButton');
                backButton.style.display = 'block';
                backButton.onclick = () => tg.close();
                
                // Применяем тему Telegram
                document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
                document.body.style.color = tg.themeParams.text_color || '#000000';
            }
        }

        // Получаем параметр pdf_url из URL
        function getPdfUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            let pdfUrl = urlParams.get('pdf_url');
            
            // Декодируем URL, если он закодирован
            if (pdfUrl) {
                try {
                    pdfUrl = decodeURIComponent(pdfUrl);
                } catch (e) {
                    console.log('URL уже декодирован');
                }
            }
            
            return pdfUrl;
        }

        // Проверяем валидность URL
        function isValidPdfUrl(url) {
            if (!url) return false;
            
            try {
                const urlObj = new URL(url);
                // Разрешаем только http и https
                if (!['http:', 'https:'].includes(urlObj.protocol)) {
                    return false;
                }
                
                // Проверяем, что это PDF файл
                if (!url.toLowerCase().endsWith('.pdf')) {
                    return false;
                }
                
                return true;
            } catch {
                return false;
            }
        }

        // Защита для TMA и браузера
        function enableProtection() {
            // Запрет контекстного меню
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            // Запрет перетаскивания
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });

            // Запрет выделения текста
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });

            // Запрет копирования
            document.addEventListener('copy', function(e) {
                e.preventDefault();
                return false;
            });

            // Запрет вырезания
            document.addEventListener('cut', function(e) {
                e.preventDefault();
                return false;
            });

            // Запрет вставки
            document.addEventListener('paste', function(e) {
                e.preventDefault();
                return false;
            });

            // Защита от Print Screen и DevTools
            document.addEventListener('keydown', function(e) {
                // Блокировка Print Screen
                if (e.key === 'PrintScreen' || (e.ctrlKey && e.key === 'p')) {
                    e.preventDefault();
                    return false;
                }
                
                // Блокировка DevTools (только в браузере)
                if (!isTelegramWebApp() && (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')))) {
                    e.preventDefault();
                    return false;
                }
            });

            // В TMA многие функции уже заблокированы, но на всякий случай
            if (!isTelegramWebApp()) {
                // Защита от модальных окон (только в браузере)
                window.alert = function() {};
                window.confirm = function() { return false; };
                window.prompt = function() { return null; };
                window.open = function() { return null; };
            }

            // Защита от инспектирования (только в браузере)
            if (!isTelegramWebApp()) {
                Object.defineProperty(document, 'hidden', { value: false });
                Object.defineProperty(document, 'visibilityState', { value: 'visible' });
            }
        }

        // Загрузка и отображение PDF
        function loadPdf(pdfUrl) {
            const container = document.getElementById('pdfContainer');
            
            try {
                // Создаем iframe для отображения PDF
                const iframe = document.createElement('iframe');
                iframe.className = 'pdf-viewer';
                
                // Настройки для PDF viewer
                const pdfViewerParams = [
                    'toolbar=0',          // Без панели инструментов
                    'navpanes=0',         // Без навигации
                    'statusbar=0',        // Без статусбара
                    'scrollbar=0',        // Без скроллбаров (где возможно)
                    'view=FitH'           // По ширине
                ].join('&');
                
                iframe.src = `${pdfUrl}#${pdfViewerParams}`;
                
                iframe.onload = function() {
                    container.innerHTML = '';
                    container.appendChild(iframe);
                    
                    // Дополнительная защита для iframe (если same-origin)
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        iframeDoc.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            return false;
                        });
                    } catch (e) {
                        // Cross-origin ограничения - нормальная ситуация
                    }
                };
                
                iframe.onerror = function() {
                    showError('Ошибка загрузки PDF файла. Проверьте ссылку и попробуйте снова.');
                };
                
            } catch (error) {
                showError('Ошибка при создании просмотрщика PDF: ' + error.message);
            }
        }

        // Показать ошибку
        function showError(message) {
            const container = document.getElementById('pdfContainer');
            container.className = 'error';
            container.innerHTML = `
                <h3>Ошибка загрузки</h3>
                <p>${message}</p>
                <button onclick="location.reload()">Попробовать снова</button>
            `;
            
            // В TMA показываем кнопку закрытия
            if (isTelegramWebApp()) {
                const backButton = document.getElementById('backButton');
                backButton.style.display = 'block';
            }
        }

        // Основная функция инициализации
        function init() {
            // Инициализируем TMA
            initTelegramWebApp();
            
            // Включаем защиту
            enableProtection();
            
            // Получаем URL PDF
            const pdfUrl = getPdfUrl();
            
            if (!isValidPdfUrl(pdfUrl)) {
                showError('Неверный URL PDF файла. Убедитесь, что ссылка начинается с http:// или https:// и ведет на PDF файл.');
                return;
            }
            
            // Показываем индикатор загрузки в TMA
            if (isTelegramWebApp()) {
                tg.showAlert('Загружаем документ...');
            }
            
            loadPdf(pdfUrl);
        }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);

        // Дополнительная защита для браузера (не для TMA)
        if (!isTelegramWebApp()) {
            setInterval(function() {
                if (document.hidden || document.visibilityState === 'hidden') {
                    document.body.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; padding: 20px; text-align: center;">
                            <h1 style="color: #e74c3c; margin-bottom: 16px;">Доступ запрещен</h1>
                            <p>Обнаружена попытка обхода защиты</p>
                        </div>
                    `;
                }
            }, 1000);

            window.addEventListener('resize', function() {
                if (window.outerWidth - window.innerWidth > 100 || 
                    window.outerHeight - window.innerHeight > 100) {
                    window.location.reload();
                }
            });
        }

        // Обработка видимости страницы для TMA
        document.addEventListener('visibilitychange', function() {
            if (isTelegramWebApp() && document.hidden) {
                // В TMA при скрытии приложения можно показать предупреждение
                if (tg) {
                    tg.showAlert('Документ был скрыт. Для продолжения работы вернитесь в приложение.');
                }
            }
        });
    </script>
</head>
</html>
